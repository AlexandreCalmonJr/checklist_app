<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Configurações - Checklist App Hospital Teresa de Lisieux">
    <title>Configurações - Checklist App</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="config.css">
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo.png" alt="Logo" class="sidebar-logo">
            <h2>Configurações</h2>
        </div>

        <nav class="sidebar-nav">
            <button class="nav-item active" data-section="unidades">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Unidades
            </button>
            <button class="nav-item" data-section="tecnicos">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Técnicos
            </button>
            <button class="nav-item" data-section="responsaveis">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <polyline points="17 11 19 13 23 9"></polyline>
                </svg>
                Responsáveis
            </button>
            <button class="nav-item" data-section="tipos">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                Tipos de Checklist
            </button>
            <button class="nav-item" data-section="locais">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                Locais
            </button>
            <button class="nav-item" data-section="itens">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                Itens do Checklist
            </button>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <span id="userEmail">usuario@email.com</span>
            </div>
            <button class="btn-logout" id="btnLogout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Sair
            </button>
            <a href="index.html" class="btn-back">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Checklist
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <button class="menu-toggle" id="menuToggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <h1 id="sectionTitle">Unidades</h1>
            <button class="btn-add" id="btnAdd">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Adicionar
            </button>
        </header>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Carregando...</p>
        </div>

        <!-- Error State -->
        <div class="error-state" id="errorState">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p id="errorText">Erro ao carregar dados</p>
            <button class="btn-retry" id="btnRetry">Tentar novamente</button>
        </div>

        <!-- Data Table -->
        <div class="table-container" id="tableContainer">
            <table class="data-table">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
            <p>Nenhum registro encontrado</p>
            <button class="btn-add-empty" id="btnAddEmpty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Adicionar primeiro registro
            </button>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Adicionar</h3>
                <button class="modal-close" id="modalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form id="modalForm">
                <div class="modal-body" id="modalBody">
                    <!-- Dynamic form fields -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" id="btnCancel">Cancelar</button>
                    <button type="submit" class="btn-save" id="btnSave">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <script type="module">
        import { authManager } from './modules/authManager.js';
        import { configManager } from './modules/configManager.js';

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        const navItems = document.querySelectorAll('.nav-item');
        const sectionTitle = document.getElementById('sectionTitle');
        const btnAdd = document.getElementById('btnAdd');
        const btnAddEmpty = document.getElementById('btnAddEmpty');
        const btnLogout = document.getElementById('btnLogout');
        const userEmail = document.getElementById('userEmail');
        const loading = document.getElementById('loading');
        const errorState = document.getElementById('errorState');
        const errorText = document.getElementById('errorText');
        const btnRetry = document.getElementById('btnRetry');
        const tableContainer = document.getElementById('tableContainer');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');
        const modalOverlay = document.getElementById('modalOverlay');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalForm = document.getElementById('modalForm');
        const modalClose = document.getElementById('modalClose');
        const btnCancel = document.getElementById('btnCancel');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        let currentSection = 'unidades';
        let currentData = [];
        let editingId = null;

        // Section configurations
        const sectionConfig = {
            unidades: {
                title: 'Unidades',
                columns: ['ID', 'Nome', 'Sigla', 'Ações'],
                fields: [
                    { name: 'id', label: 'ID (slug)', type: 'text', required: true, placeholder: 'ex: hospital-central' },
                    { name: 'nome', label: 'Nome', type: 'text', required: true, placeholder: 'Nome completo da unidade' },
                    { name: 'sigla', label: 'Sigla', type: 'text', required: true, placeholder: 'ex: HC' }
                ],
                getRowData: (item) => [item.id, item.nome, item.sigla],
                manager: {
                    get: () => configManager.getUnidades(),
                    create: (data) => configManager.createUnidade(data),
                    update: (id, data) => configManager.updateUnidade(id, data),
                    delete: (id) => configManager.deleteUnidade(id)
                }
            },
            tecnicos: {
                title: 'Técnicos',
                columns: ['ID', 'Nome', 'Status', 'Ações'],
                fields: [
                    { name: 'nome', label: 'Nome', type: 'text', required: true, placeholder: 'Nome do técnico' }
                ],
                getRowData: (item) => [item.id, item.nome, item.ativo ? '✓ Ativo' : '✗ Inativo'],
                manager: {
                    get: () => configManager.getTecnicos(),
                    create: (data) => configManager.createTecnico(data),
                    update: (id, data) => configManager.updateTecnico(id, data),
                    delete: (id) => configManager.deleteTecnico(id)
                }
            },
            responsaveis: {
                title: 'Responsáveis',
                columns: ['ID', 'Nome', 'Ações'],
                fields: [
                    { name: 'id', label: 'ID (chave)', type: 'text', required: true, placeholder: 'ex: ENFERMAGEM' },
                    { name: 'nome', label: 'Nome', type: 'text', required: true, placeholder: 'Nome do setor responsável' }
                ],
                getRowData: (item) => [item.id, item.nome],
                manager: {
                    get: () => configManager.getResponsaveis(),
                    create: (data) => configManager.createResponsavel(data),
                    update: (id, data) => configManager.updateResponsavel(id, data),
                    delete: (id) => configManager.deleteResponsavel(id)
                }
            },
            tipos: {
                title: 'Tipos de Checklist',
                columns: ['ID', 'Nome', 'Ações'],
                fields: [
                    { name: 'id', label: 'ID (chave)', type: 'text', required: true, placeholder: 'ex: emergencia' },
                    { name: 'nome', label: 'Nome', type: 'text', required: true, placeholder: 'Nome do tipo' }
                ],
                getRowData: (item) => [item.id, item.nome],
                manager: {
                    get: () => configManager.getTipos(),
                    create: (data) => configManager.createTipo(data),
                    update: (id, data) => configManager.updateTipo(id, data),
                    delete: (id) => configManager.deleteTipo(id)
                }
            },
            locais: {
                title: 'Locais',
                columns: ['ID', 'Tipo', 'Setor', 'Local', 'Responsável', 'Ações'],
                fields: [
                    { name: 'tipo_checklist_id', label: 'Tipo de Checklist', type: 'select', required: true, options: [] },
                    { name: 'setor', label: 'Setor', type: 'text', required: true, placeholder: 'Nome do setor' },
                    { name: 'local', label: 'Local', type: 'text', required: true, placeholder: 'Nome do local' },
                    { name: 'responsavel_id', label: 'Responsável', type: 'select', required: false, options: [] }
                ],
                getRowData: (item) => [item.id, item.tipo_checklist_id, item.setor, item.local, item.responsaveis?.nome || '-'],
                manager: {
                    get: async () => {
                        const result = await configManager.getLocais();
                        return result.raw || result;
                    },
                    create: (data) => configManager.createLocal(data),
                    update: (id, data) => configManager.updateLocal(id, data),
                    delete: (id) => configManager.deleteLocal(id)
                }
            },
            itens: {
                title: 'Itens do Checklist',
                columns: ['ID', 'Tipo', 'Label', 'Nome Campo', 'Opções', 'Ações'],
                fields: [
                    { name: 'tipo_checklist_id', label: 'Tipo de Checklist', type: 'select', required: true, options: [] },
                    { name: 'label', label: 'Label (exibição)', type: 'text', required: true, placeholder: 'Texto exibido' },
                    { name: 'name', label: 'Nome do Campo', type: 'text', required: true, placeholder: 'nome_do_campo' },
                    { name: 'options', label: 'Opções (JSON)', type: 'text', required: true, placeholder: '["Sim", "Não"]' }
                ],
                getRowData: (item) => [item.id, item.tipo_checklist_id, item.label, item.name, JSON.stringify(item.options)],
                manager: {
                    get: () => configManager.getItens(),
                    create: (data) => configManager.createItem({ ...data, options: JSON.parse(data.options) }),
                    update: (id, data) => configManager.updateItem(id, { ...data, options: JSON.parse(data.options) }),
                    delete: (id) => configManager.deleteItem(id)
                }
            }
        };

        // Initialize app
        async function init() {
            // Check authentication
            const isAuth = await authManager.requireAuth();
            if (!isAuth) return;

            // Show user email
            const user = authManager.getUser();
            if (user) {
                userEmail.textContent = user.email;
            }

            // Setup event listeners
            setupEventListeners();

            // Load initial section
            loadSection('unidades');
        }

        function setupEventListeners() {
            // Menu toggle
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });

            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    if (section !== currentSection) {
                        loadSection(section);
                    }
                    sidebar.classList.remove('open');
                });
            });

            // Add buttons
            btnAdd.addEventListener('click', () => openModal());
            btnAddEmpty.addEventListener('click', () => openModal());

            // Logout
            btnLogout.addEventListener('click', () => authManager.logout());

            // Retry
            btnRetry.addEventListener('click', () => loadSection(currentSection));

            // Modal
            modalClose.addEventListener('click', closeModal);
            btnCancel.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });
            modalForm.addEventListener('submit', handleSubmit);

            // Close modal on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        }

        async function loadSection(section) {
            currentSection = section;
            const config = sectionConfig[section];

            // Update UI
            sectionTitle.textContent = config.title;
            navItems.forEach(item => {
                item.classList.toggle('active', item.dataset.section === section);
            });

            // Show loading
            showLoading();

            try {
                // Load select options for locais and itens
                if (section === 'locais' || section === 'itens') {
                    await loadSelectOptions(section);
                }

                // Fetch data
                currentData = await config.manager.get();

                // Render table
                renderTable(config, currentData);
            } catch (error) {
                showError(error.message);
            }
        }

        async function loadSelectOptions(section) {
            try {
                const tipos = await configManager.getTipos();
                const tipoField = sectionConfig[section].fields.find(f => f.name === 'tipo_checklist_id');
                if (tipoField) {
                    tipoField.options = tipos.map(t => ({ value: t.id, label: t.nome }));
                }

                if (section === 'locais') {
                    const responsaveis = await configManager.getResponsaveis();
                    const respField = sectionConfig[section].fields.find(f => f.name === 'responsavel_id');
                    if (respField) {
                        respField.options = [
                            { value: '', label: '-- Selecione --' },
                            ...responsaveis.map(r => ({ value: r.id, label: r.nome }))
                        ];
                    }
                }
            } catch (error) {
                console.error('Error loading select options:', error);
            }
        }

        function renderTable(config, data) {
            // Build header
            tableHead.innerHTML = `
                <tr>
                    ${config.columns.map(col => `<th>${col}</th>`).join('')}
                </tr>
            `;

            if (!data || data.length === 0) {
                showEmpty();
                return;
            }

            // Build body
            tableBody.innerHTML = data.map(item => {
                const rowData = config.getRowData(item);
                const id = item.id;

                return `
                    <tr>
                        ${rowData.map(cell => `<td>${cell}</td>`).join('')}
                        <td class="actions">
                            <button class="btn-edit" onclick="window.editItem('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-delete" onclick="window.deleteItem('${id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            showTable();
        }

        function showLoading() {
            loading.style.display = 'flex';
            errorState.style.display = 'none';
            tableContainer.style.display = 'none';
            emptyState.style.display = 'none';
        }

        function showError(message) {
            loading.style.display = 'none';
            errorState.style.display = 'flex';
            errorText.textContent = message;
            tableContainer.style.display = 'none';
            emptyState.style.display = 'none';
        }

        function showTable() {
            loading.style.display = 'none';
            errorState.style.display = 'none';
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
        }

        function showEmpty() {
            loading.style.display = 'none';
            errorState.style.display = 'none';
            tableContainer.style.display = 'none';
            emptyState.style.display = 'flex';
        }

        function openModal(item = null) {
            editingId = item?.id || null;
            const config = sectionConfig[currentSection];

            modalTitle.textContent = item ? 'Editar' : 'Adicionar';

            // Build form fields
            modalBody.innerHTML = config.fields.map(field => {
                const value = item ? (item[field.name] || '') : '';
                const valueStr = typeof value === 'object' ? JSON.stringify(value) : value;
                const isDisabled = item && field.name === 'id' ? 'disabled' : '';

                if (field.type === 'select') {
                    return `
                        <div class="form-group">
                            <label for="${field.name}">${field.label}</label>
                            <select id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''} ${isDisabled}>
                                ${field.options.map(opt => `
                                    <option value="${opt.value}" ${opt.value === value ? 'selected' : ''}>${opt.label}</option>
                                `).join('')}
                            </select>
                        </div>
                    `;
                }

                return `
                    <div class="form-group">
                        <label for="${field.name}">${field.label}</label>
                        <input 
                            type="${field.type}" 
                            id="${field.name}" 
                            name="${field.name}" 
                            value="${valueStr}"
                            placeholder="${field.placeholder || ''}"
                            ${field.required ? 'required' : ''}
                            ${isDisabled}
                        >
                    </div>
                `;
            }).join('');

            modalOverlay.classList.add('open');
            modal.classList.add('open');

            // Focus first input
            const firstInput = modalBody.querySelector('input, select');
            if (firstInput) firstInput.focus();
        }

        function closeModal() {
            modalOverlay.classList.remove('open');
            modal.classList.remove('open');
            editingId = null;
            modalForm.reset();
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const config = sectionConfig[currentSection];
            const formData = new FormData(modalForm);
            const data = {};

            config.fields.forEach(field => {
                const value = formData.get(field.name);
                if (value !== null && value !== '') {
                    data[field.name] = value;
                }
            });

            try {
                if (editingId) {
                    await config.manager.update(editingId, data);
                    showToast('Atualizado com sucesso!', 'success');
                } else {
                    await config.manager.create(data);
                    showToast('Criado com sucesso!', 'success');
                }

                closeModal();
                loadSection(currentSection);
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Global functions for inline onclick handlers
        window.editItem = (id) => {
            const item = currentData.find(i => String(i.id) === String(id));
            if (item) openModal(item);
        };

        window.deleteItem = async (id) => {
            if (!confirm('Tem certeza que deseja excluir este item?')) return;

            const config = sectionConfig[currentSection];

            try {
                await config.manager.delete(id);
                showToast('Removido com sucesso!', 'success');
                loadSection(currentSection);
            } catch (error) {
                showToast(error.message, 'error');
            }
        };

        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = `toast show ${type}`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize
        init();
    </script>
</body>

</html>